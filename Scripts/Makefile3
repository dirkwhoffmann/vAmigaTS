# Regression testing for vAmiga 
# (C)opyright Dirk W. Hoffmann, 2022
#
# To run all regression tests:
#
#    1. Install TIFF tools 
#       brew install libtiff
#
#    2. Copy Kickstart 1.3 to /tmp
#       cp /path/to/Kickstart/kick13.rom /tmp
#
#    3. Specifiy the vAmiga executable
#       export VAMIGA=/path/to/the/vAmiga/executable/under/test
#
#    4. Run tests
#       make [-j<number of parallel threads>]

# Check if we're ready to go
KICK13 = /tmp/kick13.rom
ifndef VAMIGA
VAMIGA = /tmp/vAmiga/vAmiga.app/Contents/MacOS/vAmiga
export VAMIGA
endif

ifeq (,$(wildcard $(VAMIGA)))
    $(error vAmiga executable not found)
endif
ifeq (,$(wildcard $(KICK13)))
    $(error $(KICK13) not found)
endif

# Collect all .ini files
INI=$(wildcard */*.ini)
LOG=$(INI:.ini=.log)
TIFF=$(INI:.ini=.tiff)

.PHONY: all prepare clean

all: $(LOG) $(TIFF)
	@echo > /dev/null
		
clean:
	@rm -f */*.log

%.log: %.tiff
	@cp $(wildcard $(dir $@)*.adf) /tmp/$(basename $(@F)).adf
	@$(VAMIGA) $(basename $@).ini &> /dev/null
	@raw2tiff -p rgb -b 3 -w 716 -l 285 /tmp/$(basename $(@F)).raw /tmp/$(basename $(@F)).tiff
	@tiffcmp -t /tmp/$(basename $(@F)).tiff $(basename $@).tiff; \
	RETVAL=$$?; \
	if [ $$RETVAL -eq 0 ]; then \
		echo "$(basename $@): PASS"; \
		echo "$(basename $@): PASS" > $@; \
    else \
		echo "$(basename $@): **** FAIL ****"; \
		echo "$(basename $@): **** FAIL ****" > $@; \
	fi
	@rm /tmp/$(basename $(@F)).adf
	@rm /tmp/$(basename $(@F)).raw
	@rm /tmp/$(basename $(@F)).tiff

%.tiff:
	@echo "Creating missing TIFF image $@"
	@cp $(wildcard $(dir $@)*.adf) /tmp/$(basename $(@F)).adf
	@$(VAMIGA) $(basename $@).ini &> /dev/null
	@raw2tiff -p rgb -b 3 -w 716 -l 285 /tmp/$(basename $(@F)).raw $(basename $@).tiff
	@rm /tmp/$(basename $(@F)).adf
	@rm /tmp/$(basename $(@F)).raw
